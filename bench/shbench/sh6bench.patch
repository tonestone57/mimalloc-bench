--- sh6bench.c	2026-02-23 14:27:30.736600157 +0000
+++ sh6bench-new.c	2026-02-23 14:27:30.744600157 +0000
@@ -50,17 +50,24 @@
 #endif /* SYS_MULTI_THREAD */

 #elif defined(UNIX) || defined(__hpux) || defined(_AIX) || defined(__sun) \
-	|| defined(sgi) || defined(__DGUX__) || defined(__linux__)
+	|| defined(sgi) || defined(__DGUX__) || defined(__linux__) || defined(__HAIKU__)
 /* Unix prototypes */
 #ifndef UNIX
 #define UNIX 1
 #endif
+#ifdef __HAIKU__
+#define HAVE_PTHREAD 1
+#endif
 #include <unistd.h>
 #ifdef SYS_MULTI_THREAD
 #if defined(__hpux) || defined(__osf__) || defined(_AIX) || defined(sgi) \
-	|| defined(__DGUX__) || defined(__linux__)
+	|| defined(__DGUX__) || defined(__linux__) || defined(__HAIKU__)
 #define _INCLUDE_POSIX_SOURCE
+#ifndef __HAIKU__
 #include <sys/signal.h>
+#else
+#include <signal.h>
+#endif
 #include <pthread.h>
 typedef pthread_t ThreadID;
 #if defined(_DECTHREADS_) && !defined(__osf__)
@@ -110,7 +117,7 @@
 /* Note: the SmartHeap header files must be included _after_ any files that
  * declare malloc et al
  */
-#include "smrtheap.h"
+// #include "smrtheap.h"
 #ifdef MALLOC_ONLY
 #undef malloc
 #undef realloc
@@ -152,7 +159,7 @@
 FILE *fout, *fin;
 unsigned uMaxBlockSize = 1000;
 unsigned uMinBlockSize = 1;
-unsigned long ulCallCount = 1000;
+unsigned long ulCallCount = 10000;

 unsigned long promptAndRead(char *msg, unsigned long defaultVal, char fmtCh);

@@ -184,6 +191,7 @@

 void doBench(void *);

+unsigned int defaultThreadCount = 1;
 void main(int argc, char *argv[])
 {
	clock_t startCPU;
@@ -195,6 +203,16 @@
 #endif

	setbuf(stdout, NULL);  /* turn off buffering for output */
+#ifdef BENCH
+	fin = stdin;
+	fout = stdout;
+	defaultThreadCount = GetNumProcessors();
+	if (argc==2) {
+		char* end;
+		long l = strtol(argv[1],&end,10);
+		if (l > 0) defaultThreadCount = l;
+	}
+#else

	if (argc > 1)
		fin = fopen(argv[1], "r");
@@ -204,6 +222,7 @@
		fout = fopen(argv[2], "w");
	else
		fout = stdout;
+#endif

	ulCallCount = promptAndRead("call count", ulCallCount, 'u');
	uMinBlockSize = (unsigned)promptAndRead("min block size",uMinBlockSize,'u');
@@ -220,7 +239,7 @@
		ThreadID *tids;

 #ifdef WIN32
-		unsigned uCPUs = promptAndRead("CPUs (0 for all)", 0, 'u');
+		unsigned uCPUs = promptAndRead("CPUs (0 for all)", PROCS, 'u');

		if (uCPUs)
		{
@@ -253,10 +272,17 @@
		}
 #endif /* WIN32 */

-		uThreadCount = (int)promptAndRead("threads", GetNumProcessors(), 'u');
+		uThreadCount = (int)promptAndRead("threads", defaultThreadCount, 'u');

		if (uThreadCount < 1)
			uThreadCount = 1;
+
+		if (uThreadCount==1) {
+			startCPU = clock();
+			startTime = time(NULL);
+			doBench(NULL);
+		}
+		else {
		ulCallCount /= uThreadCount;
		if ((tids = malloc(sizeof(ThreadID) * uThreadCount)) != NULL)
		{
@@ -274,6 +300,7 @@
		}
		if (threadArg)
			free(threadArg);
+		}
	}
 #else
	startCPU = clock();
@@ -299,6 +326,7 @@
		fclose(fin);
	if (fout != stdout)
		fclose(fout);
+	exit(0);
 }

 void doBench(void *arg)
@@ -334,11 +362,18 @@
			while (iterations--)
			{

-				if (!memory || !(*mp ++ = (char *)malloc(size)))
+				if (!memory || !(*mp = (char *)malloc(size)))
				{
					printf("Out of memory\n");
					_exit (1);
				}
+				else
+				{
+					char* p = *mp;
+					p[0] = 0; p[size-1] = 0;
+					mp++;
+				}
+

	  /* while allocating skip over that portion of the buffer that still
	\t holds pointers from the previous cycle
@@ -387,6 +422,7 @@
 {
	char *arg = NULL, *err;
	unsigned long result;
+#ifndef BENCH
	{
		char buf[12];
		static char fmt[] = "\n%s [%lu]: ";
@@ -395,6 +431,7 @@
		if (fgets(buf, 11, fin))
			arg = &buf[0];
	}
+#endif
	if (arg && ((result = strtoul(arg, &err, 10)) != 0
					|| (*err == '\n' && arg != err)))
	{
@@ -429,7 +466,7 @@
							 (pthread_startroutine_t)fn, arg) == -1)
		 return THREAD_NULL;

-#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS)
+#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS) || defined(__HAIKU__)
	pthread_attr_t attr;
	pthread_attr_init(&attr);
 #ifdef _AIX
@@ -462,7 +499,7 @@
	while (tidCnt--)
		thr_join(0, NULL, NULL);

-#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS)
+#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS) || defined(__HAIKU__)
	while (tidCnt--)
		pthread_join(tids[tidCnt], NULL);

@@ -509,6 +546,8 @@
	return get_nprocs();
 #elif defined(_SC_NPROCESSORS_ONLN)
	return sysconf(_SC_NPROCESSORS_ONLN);
+#elif defined(__HAIKU__)
+	return sysconf(_SC_NPROCESSORS_ONLN);

 #elif defined(_SC_NPROCESSORS_CONF)
	return sysconf(_SC_NPROCESSORS_CONF);
