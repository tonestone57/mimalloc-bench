--- SH8BENCH.C	2026-02-22 21:57:49.022098539 +0000
+++ sh8bench-new.c	2026-02-23 07:38:22.996362178 +0000
@@ -52,15 +52,20 @@
 #endif /* SYS_MULTI_THREAD */

 #elif defined(UNIX) || defined(__hpux) || defined(_AIX) || defined(__sun) \
-	|| defined(sgi) || defined(__DGUX__) || defined(__linux__)
+	|| defined(sgi) || defined(__DGUX__) || defined(__linux__) || defined(__HAIKU__)
 /* Unix prototypes */
 #ifndef UNIX
 #define UNIX 1
 #endif
+#ifdef __HAIKU__
+#define HAVE_PTHREAD 1
+#endif
+#ifndef UNIX
+#endif
 #include <unistd.h>
 #ifdef SYS_MULTI_THREAD
 #if defined(__hpux) || defined(__osf__) || defined(_AIX) || defined(sgi) \
-	|| defined(__DGUX__) || defined(__linux__) || defined(__MVS__)
+	|| defined(__DGUX__) || defined(__linux__) || defined(__MVS__) || defined(__HAIKU__)
 #define _INCLUDE_POSIX_SOURCE
 #define _OPEN_SYS 1
 #include <signal.h>
@@ -135,7 +140,7 @@
 FILE *fout, *fin;
 unsigned uMaxBlockSize = 1000;
 unsigned uMinBlockSize = 1;
-unsigned long ulIterations   =  100000;
+unsigned long ulIterations   =  700000;
 unsigned long ulHeapSize     = 1000000;
 unsigned ulForeignAllocCount = 10000000;

@@ -177,7 +182,7 @@
 THREAD_FN_RETURN doBench(void *);


-void main(int argc, char *argv[])
+int main(int argc, char *argv[])
 {
	clock_t startCPU;
	time_t startTime;
@@ -191,7 +196,16 @@
	setbuf(stdout, NULL);  /* turn off buffering for output */

	/* @@@ change to use flags specifying which parms are passed */
-
+	#ifdef BENCH
+		fin = stdin;
+		fout = stdout;
+	  unsigned int defaultThreadCount = GetNumProcessors();
+		if (argc==2) {
+			char* end;
+			long l = strtol(argv[1],&end,10);
+			if (l != 0) defaultThreadCount = l;
+		}
+	#else
	if (argc > 1)
		fin = fopen(argv[1], "r");
	else
@@ -199,7 +213,8 @@
	if (argc > 2)
		fout = fopen(argv[2], "w");
	else
-		fout = stdout;
+		fout = stdout;
+	#endif

	if (argc > 3)
		ulHeapSize = atol(argv[3]);
@@ -215,7 +230,7 @@
	if (argc > 5)
		ulThreadCount = atol(argv[5]);
	else
-		ulThreadCount = promptAndRead("threads", ulThreadCount, 'u');
+		ulThreadCount = promptAndRead("threads", defaultThreadCount, 'u');

	if (argc > 6)
		ulForeignAllocCount = atol(argv[5]);
@@ -240,7 +255,7 @@
		void *threadArg = NULL;

 #ifdef WIN32
-		unsigned uCPUs = promptAndRead("CPUs (0 for all)", 0, 'u');
+		unsigned uCPUs = promptAndRead("CPUs (0 for all)", GetNumProcessors(), 'u');

		if (uCPUs)
		{
@@ -539,10 +554,13 @@

				mp = memory;
			}
-			else if (!(*mp++ = (char *)malloc(size)))
+			else {
+				if (!(*mp++ = (char *)malloc(size)))
			{
				printf("Out of memory\n");
				_exit (1);
+			}
+				char* p = mp[-1]; p[0] = 0; p[size-1] = 0;
			}
		}
	}
@@ -577,6 +595,7 @@
 {
	char *arg = NULL, *err;
	unsigned long result;
+#ifndef BENCH
	{
		char buf[12];
		static char fmt[] = "\n%s [%lu]: ";
@@ -585,6 +604,7 @@
		if (fgets(buf, 11, fin))
			arg = &buf[0];
	}
+#endif
	if (arg && ((result = strtoul(arg, &err, 10)) != 0
					|| (*err == '\n' && arg != err)))
	{
@@ -619,7 +639,7 @@
							 (pthread_startroutine_t)fn, arg) == -1)
		 return THREAD_NULL;

-#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS)
+#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS) || defined(__HAIKU__)
	pthread_attr_t attr;
	pthread_attr_init(&attr);
 #ifdef _AIX
@@ -654,7 +674,7 @@
	while (tidCnt--)
		thr_join(0, NULL, NULL);

-#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS)
+#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS) || defined(__HAIKU__)
	while (tidCnt--)
		pthread_join(tids[tidCnt], NULL);

@@ -701,6 +721,8 @@
	return get_nprocs();
 #elif defined(_SC_NPROCESSORS_ONLN)
	return sysconf(_SC_NPROCESSORS_ONLN);
+#elif defined(__HAIKU__)
+	return sysconf(_SC_NPROCESSORS_ONLN);

 #elif defined(_SC_NPROCESSORS_CONF)
	return sysconf(_SC_NPROCESSORS_CONF);
