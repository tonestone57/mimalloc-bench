--- a/SH8BENCH.C	2026-02-24 12:10:48.305551333 +0000
+++ b/sh8bench-new.c	2026-02-24 16:55:10.204940378 +0000
@@ -52,15 +52,18 @@
 #endif /* SYS_MULTI_THREAD */

 #elif defined(UNIX) || defined(__hpux) || defined(_AIX) || defined(__sun) \
-	|| defined(sgi) || defined(__DGUX__) || defined(__linux__)
+	|| defined(sgi) || defined(__DGUX__) || defined(__linux__) || defined(__HAIKU__)
 /* Unix prototypes */
 #ifndef UNIX
 #define UNIX 1
 #endif
+#ifdef __HAIKU__
+#define HAVE_PTHREAD 1
+#endif
 #include <unistd.h>
 #ifdef SYS_MULTI_THREAD
 #if defined(__hpux) || defined(__osf__) || defined(_AIX) || defined(sgi) \
-	|| defined(__DGUX__) || defined(__linux__) || defined(__MVS__)
+	|| defined(__DGUX__) || defined(__linux__) || defined(__MVS__) || defined(__HAIKU__)
 #define _INCLUDE_POSIX_SOURCE
 #define _OPEN_SYS 1
 #include <signal.h>
@@ -91,7 +94,7 @@
 #endif /* end of environment-specific header files */

 #ifdef SMARTHEAP
-#include "smrtheap.h"
+// #include "smrtheap.h"
 #endif

 #ifndef THREAD_NULL
@@ -177,7 +180,8 @@
 THREAD_FN_RETURN doBench(void *);


-void main(int argc, char *argv[])
+unsigned int defaultThreadCount = 1;
+int main(int argc, char *argv[])
 {
	clock_t startCPU;
	time_t startTime;
@@ -189,6 +193,18 @@
 #endif

	setbuf(stdout, NULL);  /* turn off buffering for output */
+#ifdef BENCH
+	fin = stdin;
+	fout = stdout;
+#ifdef SYS_MULTI_THREAD
+	defaultThreadCount = GetNumProcessors();
+#endif
+	if (argc==2) {
+		char* end;
+		long l = strtol(argv[1],&end,10);
+		if (l > 0) defaultThreadCount = l;
+	}
+#else

	/* @@@ change to use flags specifying which parms are passed */

@@ -200,6 +216,7 @@
		fout = fopen(argv[2], "w");
	else
		fout = stdout;
+#endif

	if (argc > 3)
		ulHeapSize = atol(argv[3]);
@@ -215,15 +232,12 @@
	if (argc > 5)
		ulThreadCount = atol(argv[5]);
	else
-		ulThreadCount = promptAndRead("threads", ulThreadCount, 'u');
+		ulThreadCount = promptAndRead("threads", defaultThreadCount, 'u');

	if (argc > 6)
-		ulForeignAllocCount = atol(argv[5]);
+		ulForeignAllocCount = atol(argv[6]);
	else
-		ulForeignAllocCount =
-							promptAndRead("allocs freed from non-allocating thread",
-											  ulForeignAllocCount, 'u');
-
+		ulForeignAllocCount = promptAndRead("foreign alloc count", ulForeignAllocCount, 'u');
 #endif /* SYS_MULTI_THREAD */

	/* @@@
@@ -386,6 +400,7 @@
		fclose(fin);
	if (fout != stdout)
		fclose(fout);
+	return 0;
 }


@@ -539,11 +554,17 @@

				mp = memory;
			}
-			else if (!(*mp++ = (char *)malloc(size)))
+			else if (!(*mp = (char *)malloc(size)))
			{
				printf("Out of memory\n");
				_exit (1);
			}
+			else
+			{
+				char* p = *mp;
+				p[0] = 0; p[size-1] = 0;
+				mp++;
+			}
		}
	}

@@ -571,20 +592,21 @@
	MemPoolCheck(MemDefaultPool);
	MemPoolCheck(0);
 #endif
+	return (THREAD_FN_RETURN)0;
 }

 unsigned long promptAndRead(char *msg, unsigned long defaultVal, char fmtCh)
 {
	char *arg = NULL, *err;
	unsigned long result;
-	{
-		char buf[12];
-		static char fmt[] = "\n%s [%lu]: ";
-		fmt[7] = fmtCh;
-		fprintf_silent(fout, fmt, msg, defaultVal);
-		if (fgets(buf, 11, fin))
-			arg = &buf[0];
-	}
+	char buf[12];
+#ifndef BENCH
+	static char fmt[] = "\n%s [%lu]: ";
+	fmt[7] = fmtCh;
+	fprintf_silent(fout, fmt, msg, defaultVal);
+	if (fgets(buf, 11, fin))
+		arg = &buf[0];
+#endif
	if (arg && ((result = strtoul(arg, &err, 10)) != 0
					|| (*err == '\n' && arg != err)))
	{
@@ -619,7 +641,7 @@
							 (pthread_startroutine_t)fn, arg) == -1)
		 return THREAD_NULL;

-#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS)
+#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS) || defined(__HAIKU__)
	pthread_attr_t attr;
	pthread_attr_init(&attr);
 #ifdef _AIX
@@ -654,7 +676,7 @@
	while (tidCnt--)
		thr_join(0, NULL, NULL);

-#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS)
+#elif defined(_POSIX_THREADS) || defined(_POSIX_REENTRANT_FUNCTIONS) || defined(__HAIKU__)
	while (tidCnt--)
		pthread_join(tids[tidCnt], NULL);
